<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js@latest/dist/web3.min.js"></script>
</head>

<body>
    <h2>
        当前地址：<span id="address"></span>
    </h2>
    <h2>
        当前地址余额：<span id="value"></span>
    </h2>
    <h3>
        其余授权地址：<span id="address1"></span>
    </h3>
    <p>

        账号：<input type="text" id="toAccount">
    </p>
    金额：<input type="text" id="ether">
    <button id="sned">
        转账
    </button>
    <script type="module">
        // 创建Web3实例
        const web3 = new Web3(Web3.givenProvider || "http://localhost:8545");

        // 添加点击事件
        sned.onclick = () => {
            web3.eth.sendTransaction({
                from: address.innerHTML,
                to: toAccount.value,
                value: web3.utils.toWei(ether.value, 'ether')
            }).then(() => {
                alert('转换完毕')
                getEthBalance()
            })
        }

        async function link() {
            try {
                // if (window.ethereum) {
                //     alert('Metamask 已安装')
                // } else {
                //     alert('Metamask 未安装')
                // }
                // ethereum.request({ method: 'eth_requestAccounts' })
                //     .then(accounts => {
                //         alert("Metamask 已连接！");
                //         // 在这里可以执行连接后的操作
                //     })
                //     .catch(error => {
                //         alert("连接到 Metamask 失败:", error);
                //     });
                const res = await web3.eth.requestAccounts()
                address.innerHTML = res.shift()
                address1.innerHTML = res.join(',')
                // 在这里可以执行连接后的操作
            } catch (error) {
                alert("连接到 Metamask 失败:", error);
            }
        }

        // 定义一个异步函数
        async function getEthBalance() {
            try {
                // web3.eth.getBlockNumber()
                // web3.eth.getChainId()
                web3.eth.getAccounts((error, accounts) => {
                    if (error) {
                        console.error(error);
                    } else {
                        console.log('连接的账户:', accounts);
                    }
                });
                const amount = await web3.eth.getBalance(address.innerHTML);
                const balance = web3.utils.fromWei(amount)
                value.innerHTML = `${balance} ETH`
            } catch (error) {
                // 捕获并处理可能发生的错误
                console.error("Error fetching balance:", error);
            }
        }
        (async () => {
            await link();
            // link 方法执行完毕后，再执行后续代码
            // 调用异步函数
            getEthBalance();
        })();
    </script>
</body>

</html>